<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AlturaTime — Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/ical.js@1.4.0/build/ical.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <style>
    body { font-family:'Lato',sans-serif; background:#f8fafb; margin:0; padding:20px; color:#203040; }
    .main-title { font-family:'Nunito',sans-serif; font-size:2.2em; color:#2a9078; font-weight:900; text-align:center; }
    .container { max-width:900px; margin:0 auto; }
    .card { background:white; border-radius:10px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin:20px auto; text-align:center }
    .city-label { font-weight:bold; color:#e27d60; margin-bottom:6px }
    .time { font-size:2rem; font-weight:700; color:#2a9078 }
    .call-status.safe { background:#5fb878; color:#fff; padding:6px 12px; border-radius:8px; display:inline-block }
    .call-status.avoid { background:#ef476f; color:#fff; padding:6px 12px; border-radius:8px; display:inline-block }
    .small { font-size:0.95em; color:#666; margin-top:6px }
    #debug { text-align:left; margin-top:12px; color:#666; font-size:0.85rem; max-width:900px; margin-left:auto; margin-right:auto; display:none; }
    .event-debug { background:#f0f4f8; border-radius:6px; margin:6px 0; padding:4px 8px; font-size:0.93em; }
    .event-debug strong { color:#2a9078; }
    .error { color: #ef476f; }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-title">AlturaTime</div>
    <div id="viewerCard" class="card">
      <div class="city-label" id="cityLabel">Loading schedule...</div>
      <div class="time" id="timeDisplay">--:--</div>
      <div style="margin-top:8px"><span id="statusBadge" class="call-status">--</span></div>
      <div id="nextInfo" class="small"></div>
    </div>
    <div id="debug"></div>
  </div>

<script>
const SUPABASE_URL = "https://ombkqnafbmxwqlwfucva.supabase.co";
const SUPABASE_KEY = "YeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYmtxbmFmYm14d3Fsd2Z1Y3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjQ3OTksImV4cCI6MjA3MzcwMDc5OX0.S3h51nwxvAlMa4Vv0VwI3B9FrbBp9C1UCjlJHA0CsRg";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const params = new URLSearchParams(location.search);
const fileId = params.get("id");
const name = params.get("name") || "Student";
const cityLabel = document.getElementById("cityLabel");
const timeDisplay = document.getElementById("timeDisplay");
const statusBadge = document.getElementById("statusBadge");
const nextInfo = document.getElementById("nextInfo");
const debugEl = document.getElementById("debug");

if (params.get("debug") === "1") {
  debugEl.style.display = "block";
}

if (!fileId) {
  cityLabel.innerText = "Missing schedule id (use the share link).";
  throw new Error("Missing file id");
}
cityLabel.innerText = `${decodeURIComponent(name)}'s Schedule`;

function formatTimeInTZ(dt, tz) {
  return window.luxon.DateTime.fromJSDate(dt, {zone: tz}).toLocaleString(window.luxon.DateTime.TIME_SIMPLE);
}
function getHourInTZ(dt, tz) {
  return window.luxon.DateTime.fromJSDate(dt, {zone: tz}).hour;
}
function getNowInTZ(tz) {
  return window.luxon.DateTime.now().setZone(tz);
}
function icalTimeToLuxon(icalTime, tzid) {
  if (icalTime.isDate) {
    return window.luxon.DateTime.fromISO(icalTime.toString(), {zone: tzid});
  }
  if (icalTime.zone && icalTime.zone.tzid) {
    return window.luxon.DateTime.fromJSDate(icalTime.toJSDate(), {zone: icalTime.zone.tzid});
  }
  return window.luxon.DateTime.fromJSDate(icalTime.toJSDate(), {zone: tzid});
}

async function loadScheduleAndRender() {
  const { data, error } = supabase.storage.from("schedules").getPublicUrl(`${fileId}.ics`);
  if (error || !data?.publicUrl) {
    cityLabel.innerText = "Schedule not found";
    if (params.get("debug")==="1") debugEl.innerHTML = `<div class="error">Supabase error: ${error?.message || "Unknown"}</div>`;
    return;
  }
  const res = await fetch(data.publicUrl);
  if (!res.ok) {
    cityLabel.innerText = "Schedule fetch failed";
    if (params.get("debug")==="1") debugEl.innerHTML = `<div class="error">Fetch error: ${res.status}</div>`;
    return;
  }
  const icsText = await res.text();

  let jcal, comp, tz;
  try {
    jcal = ICAL.parse(icsText);
    comp = new ICAL.Component(jcal);
    tz = comp.getFirstPropertyValue('x-wr-timezone');
    if (!tz) {
      const tzComp = comp.getFirstSubcomponent('vtimezone');
      if (tzComp) tz = tzComp.getFirstPropertyValue('tzid');
    }
    tz = tz || 'UTC';
  } catch (err) {
    if (params.get("debug")==="1") debugEl.innerHTML = `<div class="error">ICS parse error: ${err}</div>`;
    return;
  }

  // Use Luxon for all date comparisons
  let nowTz = getNowInTZ(tz);
  let rangeStart = nowTz.minus({days: 1});
  let rangeEnd = nowTz.plus({days: 14});

  // Debug: print schedule timezone and now
  if (params.get("debug")==="1") {
    debugEl.innerHTML += `<div><strong>Schedule timezone:</strong> ${tz}</div>`;
    debugEl.innerHTML += `<div><strong>Current time in schedule timezone:</strong> ${nowTz.toFormat("yyyy-MM-dd HH:mm:ss")}</div>`;
    debugEl.innerHTML += `<div><strong>Range start:</strong> ${rangeStart.toFormat("yyyy-MM-dd HH:mm")}, <strong>Range end:</strong> ${rangeEnd.toFormat("yyyy-MM-dd HH:mm")}</div>`;
  }

  const vevents = comp.getAllSubcomponents('vevent') || [];
  const occurrences = [];
  let debugEvents = [];

  for (const v of vevents) {
    try {
      const ev = new ICAL.Event(v);
      let durMs = 0;
      try {
        durMs = ev.endDate.toJSDate().getTime() - ev.startDate.toJSDate().getTime();
      } catch {}
      const hasRrule = v.getFirstProperty('rrule') !== null;
      const hasRdate = v.getFirstProperty('rdate') !== null;
      if (hasRrule || hasRdate) {
        const dtstart = ev.startDate;
        const exp = new ICAL.RecurExpansion({ component: v, dtstart });
        let next;
        let expandCount = 0;
        while ((next = exp.next())) {
          expandCount++;
          const occStartLuxon = icalTimeToLuxon(next, tz);
          const occEndLuxon = occStartLuxon.plus({milliseconds: durMs});
          debugEvents.push({
            summary: ev.summary || '',
            start: occStartLuxon,
            end: occEndLuxon,
            rawStart: next.toString(),
            rawEnd: occEndLuxon.toFormat("yyyy-MM-dd HH:mm"),
            rrule: v.getFirstPropertyValue('rrule'),
            uid: v.getFirstPropertyValue('uid')
          });
          if (occStartLuxon > rangeEnd) break;
          if (occEndLuxon >= rangeStart && occStartLuxon <= rangeEnd) {
            occurrences.push({
              start: occStartLuxon,
              end: occEndLuxon,
              summary: ev.summary || ''
            });
          }
        }
      } else {
        const sLuxon = icalTimeToLuxon(ev.startDate, tz);
        let eLuxon;
        if (ev.endDate) {
          eLuxon = icalTimeToLuxon(ev.endDate, tz);
        } else {
          eLuxon = sLuxon.plus({milliseconds: durMs});
        }
        debugEvents.push({
          summary: ev.summary || '',
          start: sLuxon,
          end: eLuxon,
          rawStart: ev.startDate.toString(),
          rawEnd: eLuxon.toFormat("yyyy-MM-dd HH:mm"),
          rrule: null,
          uid: v.getFirstPropertyValue('uid')
        });
        if (eLuxon >= rangeStart && sLuxon <= rangeEnd) {
          occurrences.push({ start: sLuxon, end: eLuxon, summary: ev.summary || '' });
        }
      }
    } catch (err) {
      if (params.get("debug")==="1") debugEl.innerHTML += `<div class="error">Event parse error: ${err}</div>`;
    }
  }
  occurrences.sort((a,b)=>a.start-b.start);

  // Debug output: show ALL parsed event instances, not just range
  if (params.get("debug")==="1") {
    debugEl.innerHTML += `<div><strong>All expanded events (in schedule timezone):</strong></div>`;
    for (let i=0;i<debugEvents.length;i++) {
      const o = debugEvents[i];
      debugEl.innerHTML += `<div class="event-debug">
        <strong>${o.summary}</strong><br>
        Start: <span>${o.start.toFormat("yyyy-MM-dd HH:mm")}</span>
        End: <span>${o.end.toFormat("yyyy-MM-dd HH:mm")}</span><br>
        Raw DTSTART: <code>${o.rawStart}</code><br>
        RRULE: <code>${o.rrule || ''}</code><br>
        UID: <code>${o.uid}</code>
      </div>`;
    }
    debugEl.innerHTML += `<div><strong>Upcoming occurrences (within range):</strong> (${occurrences.length})</div>`;
    for (let i=0;i<occurrences.length;i++) {
      const o = occurrences[i];
      debugEl.innerHTML += `<div class="event-debug">
        <strong>${o.summary}</strong><br>
        Start: <span>${o.start.toFormat("yyyy-MM-dd HH:mm")}</span>
        End: <span>${o.end.toFormat("yyyy-MM-dd HH:mm")}</span>
      </div>`;
    }
  }

  // Find current/next event in the student timezone
  let now = nowTz;
  const inOcc = occurrences.find(o=> now>=o.start && now<=o.end);
  const nextOcc = occurrences.find(o=> o.start>now);

  function updateClock() {
    now = getNowInTZ(tz);
    timeDisplay.textContent = now.toLocaleString(window.luxon.DateTime.TIME_SIMPLE);
    updateStatus();
  }

  function updateStatus() {
    const hourInTz = now.hour;
    const isNight = (hourInTz < 7) || (hourInTz >= 21);

    const currentOcc = occurrences.find(o=> now>=o.start && now<=o.end);
    const nextOccur = occurrences.find(o=> o.start>now);

    if (currentOcc) {
      statusBadge.className = 'call-status avoid';
      statusBadge.textContent = 'CLASS IN SESSION';
      const minsLeft = Math.max(0, Math.round(currentOcc.end.diff(now,"minutes").minutes));
      nextInfo.textContent = `${currentOcc.summary} — ends in ${Math.floor(minsLeft/60)>0 ? Math.floor(minsLeft/60)+' hr ' : ''}${minsLeft%60} min`;
    } else if (isNight) {
      statusBadge.className = 'call-status avoid';
      statusBadge.textContent = 'AVOID CALLING';
      if (nextOccur) {
        const mins = Math.round(nextOccur.start.diff(now,"minutes").minutes);
        nextInfo.textContent = `Next class in ${Math.floor(mins/60)>0 ? Math.floor(mins/60)+' hr ' : ''}${mins%60} min`;
      } else {
        nextInfo.textContent = 'No upcoming classes found.';
      }
    } else {
      statusBadge.className = 'call-status safe';
      statusBadge.textContent = 'GOOD TO CALL';
      if (nextOccur) {
        const mins = Math.round(nextOccur.start.diff(now,"minutes").minutes);
        nextInfo.textContent = `Next class in ${Math.floor(mins/60)>0 ? Math.floor(mins/60)+' hr ' : ''}${mins%60} min`;
      } else {
        nextInfo.textContent = 'No upcoming classes found.';
      }
    }
  }

  updateClock();
  setInterval(updateClock, 30000);
  updateStatus();
}
loadScheduleAndRender();
</script>
</body>
</html>
