<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AlturaTime — Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/ical.js@1.4.0/build/ical.min.js"></script>
  <style>
    :root{--accent:#2a9078;--muted:#6b7280;--bg:#f6fbfa;--card:#fff;--danger:#d62828}
    body{margin:0;font-family:Lato,Inter,system-ui;background:var(--bg);color:#0f172a}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    .brand{font-family:Nunito,Inter;font-size:28px;color:var(--accent);font-weight:900;text-align:center}
    .lead{color:var(--muted);text-align:center;margin-top:6px}
    .card{background:var(--card);border-radius:12px;padding:18px;margin-top:18px;box-shadow:0 10px 30px rgba(15,23,42,0.06)}
    .topRow{display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap}
    .tz{font-weight:600;color:#ef7b68}
    .timeLarge{font-size:2.4rem;color:var(--accent);font-weight:800}
    .status{padding:8px 12px;border-radius:8px;font-weight:700;display:inline-block}
    .status.safe{background:#5fb878;color:#fff}
    .status.avoid{background:var(--danger);color:#fff}
    .small{font-size:0.95rem;color:var(--muted)}
    .btn{background:transparent;border:1px solid #e6eef0;padding:8px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">AlturaTime</div>
    <div class="lead">See when it’s the right time to call</div>

    <div class="card">
      <div class="topRow">
        <div>
          <div id="nameTitle" style="font-weight:700;font-size:1.1rem">Loading…</div>
          <div class="tz small" id="tzLabel">Timezone</div>
        </div>
        <div style="text-align:right">
          <div id="timeDisplay" class="timeLarge">--:--</div>
          <div style="margin-top:8px" id="statusBadge" class="status">--</div>
        </div>
      </div>
      <div style="margin-top:12px" class="small" id="nextInfo">Next class —</div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
        <button class="btn" id="copyLinkBtn">Copy link</button>
        <button class="btn" id="printBtn">Print</button>
      </div>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://ombkqnafbmxwqlwfucva.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYmtxbmFmYm14d3Fsd2Z1Y3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjQ3OTksImV4cCI6MjA3MzcwMDc5OX0.S3h51nwxvAlMa4Vv0VwI3B9FrbBp9C1UCjlJHA0CsRg";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  const name = decodeURIComponent(params.get('name') || 'Student');

  const nameTitle = document.getElementById('nameTitle');
  const tzLabel = document.getElementById('tzLabel');
  const timeDisplay = document.getElementById('timeDisplay');
  const statusBadge = document.getElementById('statusBadge');
  const nextInfo = document.getElementById('nextInfo');

  nameTitle.textContent = `${name}'s Schedule`;

  let occurrences = [], scheduleTz = 'UTC';

  function formatInTZ(date, tz) {
    return date.toLocaleString('en-US', {timeZone: tz, hour:'numeric', minute:'2-digit', hour12:true});
  }

  async function loadSchedule() {
    const { data } = supabase.storage.from('schedules').getPublicUrl(`${id}.ics`);
    if (!data?.publicUrl) { nameTitle.textContent = 'Schedule not found'; return; }

    const res = await fetch(data.publicUrl);
    if (!res.ok) { nameTitle.textContent = 'Failed to fetch schedule'; return; }

    const txt = await res.text();
    const clean = txt.replace(/^\uFEFF/, '');
    const jcal = ICAL.parse(clean);
    const comp = new ICAL.Component(jcal);

    scheduleTz = comp.getFirstPropertyValue?.('x-wr-timezone') || comp.getFirstSubcomponent('vtimezone')?.getFirstPropertyValue('tzid') || 'UTC';
    tzLabel.textContent = scheduleTz;

    const vevents = comp.getAllSubcomponents('vevent') || [];
    occurrences = [];

    for (const v of vevents) {
      try {
        const ev = new ICAL.Event(v);
        const dur = ev.endDate ? (ev.endDate.toJSDate().getTime() - ev.startDate.toJSDate().getTime()) : 0;
        if (v.getFirstProperty('rrule') || v.getFirstProperty('rdate')) {
          const exp = new ICAL.RecurExpansion({component:v, dtstart: ev.startDate});
          let next;
          while ((next = exp.next())) {
            const s = next.toJSDate();
            if (s > Date.now() + 14*864e5) break;
            occurrences.push({start:s,end:new Date(s.getTime()+dur),summary:ev.summary});
          }
        } else {
          const s = ev.startDate.toJSDate();
          const e = ev.endDate ? ev.endDate.toJSDate() : new Date(s.getTime()+dur);
          occurrences.push({start:s,end:e,summary:ev.summary});
        }
      } catch {}
    }
    occurrences.sort((a,b)=>a.start-b.start);
    updateStatus();
    setInterval(updateStatus, 30000);
  }

  function updateStatus() {
    const now = new Date();
    const nowMs = now.getTime();
    const inClass = occurrences.find(o => nowMs >= o.start.getTime() && nowMs <= o.end.getTime());
    const next = occurrences.find(o => o.start.getTime() > nowMs);

    timeDisplay.textContent = formatInTZ(now, scheduleTz);
    const hourInTz = parseInt(new Date().toLocaleString('en-US',{timeZone:scheduleTz,hour:'2-digit',hour12:false}));
    const isNight = (hourInTz < 7 || hourInTz >= 21);

    if (inClass) {
      statusBadge.className = 'status avoid';
      statusBadge.textContent = 'DO NOT CALL — CLASS IN PROGRESS';
      const mins = Math.round((inClass.end.getTime()-nowMs)/60000);
      nextInfo.textContent = `${inClass.summary} — ends in ${Math.floor(mins/60)>0?Math.floor(mins/60)+' hr ':''}${mins%60} min`;
    } else if (isNight) {
      statusBadge.className = 'status avoid';
      statusBadge.textContent = 'DO NOT CALL — NIGHT TIME';
      if (next) {
        const mins = Math.round((next.start.getTime()-nowMs)/60000);
        nextInfo.textContent = `Next class in ${Math.floor(mins/60)>0?Math.floor(mins/60)+' hr ':''}${mins%60} min`;
      }
    } else {
      statusBadge.className = 'status safe';
      statusBadge.textContent = 'GOOD TO CALL';
      if (next) {
        const mins = Math.round((next.start.getTime()-nowMs)/60000);
        nextInfo.textContent = `Next class in ${Math.floor(mins/60)>0?Math.floor(mins/60)+' hr ':''}${mins%60} min`;
      }
    }
  }

  document.getElementById('copyLinkBtn').onclick = ()=> {
    navigator.clipboard.writeText(location.href).then(()=> alert('Link copied'));
  };
  document.getElementById('printBtn').onclick = ()=> window.print();

  loadSchedule();
</script>
</body>
</html>
