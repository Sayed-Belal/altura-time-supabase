<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AlturaTime — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--accent:#2a9078;--bg:#f6fbfa;--card:#ffffff}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#2a9078 0%, #1f6f5b 70%);padding:28px;color:#fff}
    .wrap{max-width:920px;margin:0 auto}
    header{text-align:center;margin-bottom:18px}
    .title{font-weight:700;color:#fff;font-size:28px}
    .subtitle{color:rgba(255,255,255,0.9);margin-top:6px}
    .desc{margin-top:10px;color:rgba(255,255,255,0.85);font-size:15px;line-height:1.5}
    .card{background:var(--card);color:#0f172a;border-radius:12px;padding:18px;margin-top:18px;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
    label.file{display:inline-block;background:#ef7b68;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;margin-right:12px}
    input[type="file"]{display:none}
    input[type="text"]{width:100%;padding:12px;border-radius:8px;border:1px solid #e6eef0;font-size:15px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
    button.primary{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.25);padding:8px 12px;border-radius:10px;cursor:pointer;color:#fff}
    .linkBox{margin-top:14px}
    footer{margin-top:30px;text-align:center;color:rgba(255,255,255,0.9);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">AlturaTime</div>
      <div class="subtitle">Your availability, made simple</div>
      <div class="desc">Upload your class schedule once, and share a single link with your loved ones. They’ll always know the right time to call — avoiding classes and night hours automatically.</div>
    </header>

    <section class="card">
      <input id="studentName" type="text" placeholder="Student's name (e.g., Sayed Belal)" aria-label="Student name">

      <div class="row">
        <label class="file" for="icsFile">Choose .ics file</label>
        <div id="fileName" style="color:#475569;font-size:14px">No file chosen</div>
        <input id="icsFile" type="file" accept=".ics">
      </div>

      <div class="row" style="margin-top:12px">
        <button class="primary" id="uploadBtn">Upload & Create Link</button>
        <button class="ghost" id="clearLocal">Clear Local</button>
        <div style="flex:1"></div>
        <button class="ghost" id="toggleDark">Toggle Dark</button>
      </div>

      <div id="resultArea" class="linkBox"></div>
    </section>

    <footer>Made with ♥ — AlturaTime</footer>
  </div>

<script>
  const SUPABASE_URL = "https://ombkqnafbmxwqlwfucva.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYmtxbmFmYm14d3Fsd2Z1Y3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjQ3OTksImV4cCI6MjA3MzcwMDc5OX0.S3h51nwxvAlMa4Vv0VwI3B9FrbBp9C1UCjlJHA0CsRg";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  function getBaseURL() {
    let path = location.pathname;
    if (path.endsWith('/')) return location.origin + path;
    return location.origin + path.substring(0, path.lastIndexOf('/') + 1);
  }

  const icsFile = document.getElementById('icsFile');
  const fileName = document.getElementById('fileName');
  const uploadBtn = document.getElementById('uploadBtn');
  const resultArea = document.getElementById('resultArea');
  const clearLocal = document.getElementById('clearLocal');
  const toggleDark = document.getElementById('toggleDark');

  icsFile.addEventListener('change', e => {
    const f = e.target.files[0];
    fileName.textContent = f ? f.name : 'No file chosen';
  });

  uploadBtn.addEventListener('click', async () => {
    const name = document.getElementById('studentName').value.trim();
    const f = icsFile.files[0];
    if (!name || !f) return alert('Please enter a name and choose an .ics file');

    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Uploading...';
    resultArea.innerHTML = '';

    const fileId = Math.random().toString(36).slice(2,10);
    const path = `${fileId}.ics`;

    try {
      const { error } = await supabase.storage.from('schedules').upload(path, f, { cacheControl: '3600', upsert: false });
      if (error) throw error;

      const base = getBaseURL();
      const viewLink = `${base}view.html?id=${fileId}&name=${encodeURIComponent(name)}`;

      resultArea.innerHTML = `
        <div>
          <div style="font-weight:600;margin-bottom:6px">Shareable link</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="shareInput" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef0" value="${viewLink}">
            <button class="primary" id="copyBtn" style="padding:8px 10px">Copy</button>
          </div>
        </div>`;
      document.getElementById('copyBtn').onclick = ()=> navigator.clipboard.writeText(viewLink).then(()=> alert('Copied link'));
    } catch (err) {
      console.error(err);
      alert('Upload failed: ' + (err.message || JSON.stringify(err)));
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload & Create Link';
    }
  });

  clearLocal.addEventListener('click', ()=> {
    localStorage.removeItem('altura_preview');
    alert('Local data cleared');
  });

  toggleDark.addEventListener('click', ()=> {
    document.documentElement.classList.toggle('dark');
    document.body.style.background = document.documentElement.classList.contains('dark')
      ? '#021712'
      : 'linear-gradient(180deg,#2a9078 0%, #1f6f5b 70%)';
  });
</script>
</body>
</html>
